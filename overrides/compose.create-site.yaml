# Site Creation Override
# Automatically creates ERPNext site when SITE_NAME is configured
# Based on official frappe_docker pwd.yml pattern

services:
  create-site:
    image: ${CUSTOM_IMAGE:-frappe/erpnext}:${CUSTOM_TAG:-latest}
    restart: "no"
    command:
      - bash
      - -c
      - |
        wait-for-it -t 120 db:3306
        wait-for-it -t 120 redis-cache:6379
        wait-for-it -t 120 redis-queue:6379
        
        export start=`date +%s`
        until [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".db_host // empty"` ]] && \
              [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".redis_cache // empty"` ]] && \
              [[ -n `grep -hs ^ sites/common_site_config.json | jq -r ".redis_queue // empty"` ]]; do
          echo "Waiting for sites/common_site_config.json to be created"
          sleep 5
          if (( `date +%s`-start > 120 )); then
            echo "could not find sites/common_site_config.json with required keys"
            exit 1
          fi
        done
        
        echo "Configurator ready! Checking if site ${SITE_NAME} exists..."
        
        if [[ ! -d "sites/${SITE_NAME}" ]]; then
          echo "Creating site: ${SITE_NAME}"
          bench new-site ${SITE_NAME} --no-mariadb-socket --admin-password=${ADMIN_PASSWORD} --db-root-password=${DB_ROOT_PASSWORD} --install-app=${INSTALL_APPS} --set-default
          echo "✅ Site ${SITE_NAME} created successfully"
        else
          echo "✅ Site ${SITE_NAME} already exists"
        fi
    depends_on:
      - db
      - redis-cache
      - redis-queue
      - configurator
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    environment:
      SITE_NAME: ${SITE_NAME}
      DB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
      INSTALL_APPS: ${INSTALL_APPS:-erpnext}
