# Dutch RGS 3.7 Support Override
# Uses Docker Compose profiles for clean, optional RGS integration
# Compatible with all existing overrides using YAML anchors

x-customizable-image: &customizable_image
  # Override to use RGS-enabled image built from layered Containerfile
  build:
    context: .
    dockerfile: images/rgs/Containerfile
    args:
      ERPNEXT_VERSION: ${ERPNEXT_VERSION:-v15.0.0}
  pull_policy: ${PULL_POLICY:-never}
  restart: ${RESTART_POLICY:-unless-stopped}

# Environment anchor for Dutch RGS configuration
x-rgs-environment: &rgs_environment
  RGS_VERSION: "3.7"
  COUNTRY_CODE: "NL"
  LANG: "nl_NL.UTF-8"
  TZ: "Europe/Amsterdam"

# Environment anchor for Dutch locale only (lighter footprint)
x-dutch-locale: &dutch_locale
  LANG: "nl_NL.UTF-8"
  TZ: "Europe/Amsterdam"

services:
  configurator:
    profiles: ["", "rgs"]  # Available in default and rgs profiles
    environment:
      <<: *rgs_environment
    command:
      - >
        ls -1 apps > sites/apps.txt;
        bench set-config -g db_host $$DB_HOST;
        bench set-config -gp db_port $$DB_PORT;
        bench set-config -g redis_cache "redis://$$REDIS_CACHE";
        bench set-config -g redis_queue "redis://$$REDIS_QUEUE";
        bench set-config -g redis_socketio "redis://$$REDIS_QUEUE";
        bench set-config -gp socketio_port $$SOCKETIO_PORT;
        
        if [ "$$COMPOSE_PROFILES" = "rgs" ]; then
          echo "ðŸ‡³ðŸ‡± RGS Profile Active: Setting up Dutch RGS 3.7 integration...";
          
          if [ ! -d "sites/$$SITE_NAME" ]; then
            echo "Creating site $$SITE_NAME with RGS support...";
            bench new-site $$SITE_NAME --admin-password=$$ADMIN_PASSWORD --install-app erpnext;
          else
            echo "Site $$SITE_NAME already exists";
          fi;
          
          echo "Installing Dutch RGS 3.7 custom fields...";
          bench --site $$SITE_NAME execute /home/frappe/rgs_scripts/add_complete_rgs.py;
          
          echo "âœ… Dutch RGS 3.7 setup completed for site $$SITE_NAME";
        fi;
      
  backend:
    profiles: ["", "rgs"]  # Available in default and rgs profiles  
    environment:
      <<: *rgs_environment
    image: frappe/erpnext:rgs-latest

  frontend:
    profiles: ["", "rgs"]  # Available in default and rgs profiles
    environment:
      <<: *dutch_locale

  scheduler:
    profiles: ["", "rgs"]  # Available in default and rgs profiles
    environment:
      <<: *rgs_environment
    image: frappe/erpnext:rgs-latest

  queue-short:
    profiles: ["", "rgs"]  # Available in default and rgs profiles
    environment:
      <<: *rgs_environment
    image: frappe/erpnext:rgs-latest

  queue-long:
    profiles: ["", "rgs"]  # Available in default and rgs profiles
    environment:
      <<: *rgs_environment
    image: frappe/erpnext:rgs-latest

  websocket:
    profiles: ["", "rgs"]  # Available in default and rgs profiles
    environment:
      <<: *dutch_locale
