# Dutch RGS 3.7 Installer Override
# Installs RGS custom fields after site creation
# Only active with 'rgs' profile

# Environment anchor for Dutch RGS configuration
x-rgs-environment: &rgs_environment
  RGS_VERSION: "3.7"
  COUNTRY_CODE: "NL"
  LANG: "nl_NL.UTF-8"
  TZ: "Europe/Amsterdam"

services:
  rgs-installer:
    image: frappe/erpnext:rgs-latest
    restart: "no"
    environment:
      <<: *rgs_environment
      SITE_NAME: ${SITE_NAME}
    command:
      - bash
      - -c
      - |
        echo "üá≥üá± Dutch RGS 3.7 Installer"
        echo "============================="
        echo "Waiting for site ${SITE_NAME} to be ready..."
        
        # Wait for site to exist
        export start=`date +%s`
        until [[ -d "sites/${SITE_NAME}" ]] && [[ -f "sites/${SITE_NAME}/site_config.json" ]]; do
          echo "Waiting for site ${SITE_NAME} to be created..."
          sleep 5
          if (( `date +%s`-start > 300 )); then
            echo "‚ùå Timeout waiting for site ${SITE_NAME}"
            exit 1
          fi
        done
        
        echo "‚úÖ Site ${SITE_NAME} is ready!"
        
        # Check if RGS is already installed
        if bench --site ${SITE_NAME} execute frappe.db.exists --args "['Custom Field', {'dt': 'Account', 'fieldname': 'rgs_code'}]" | grep -q "True"; then
          echo "‚úÖ RGS custom fields already installed"
          exit 0
        fi
        
        echo "Installing RGS 3.7 custom fields..."
        cd /home/frappe/frappe-bench
        
        # Run RGS installation with proper environment
        bash -c "source env/bin/activate && python3 << 'PYTHON_EOF'
import sys
import os
sys.path.append('/home/frappe/frappe-bench')
os.chdir('/home/frappe/frappe-bench')

import frappe
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

site_name = os.environ.get('SITE_NAME')
frappe.init(site=site_name)
frappe.connect()

def add_rgs_fields():
    logging.info('Adding Dutch RGS 3.7 custom fields...')
    
    # RGS Referentiecode
    if not frappe.db.exists('Custom Field', {'dt': 'Account', 'fieldname': 'rgs_code'}):
        frappe.get_doc({
            'doctype': 'Custom Field',
            'dt': 'Account',
            'label': 'RGS Referentiecode',
            'fieldname': 'rgs_code',
            'fieldtype': 'Data',
            'description': 'Nederlandse RGS code voor belastingrapportage volgens versie 3.7',
            'insert_after': 'account_currency'
        }).insert()
        logging.info('‚úÖ RGS Referentiecode field added')
    
    # RGS Omslagcode
    if not frappe.db.exists('Custom Field', {'dt': 'Account', 'fieldname': 'rgs_group_code'}):
        frappe.get_doc({
            'doctype': 'Custom Field',
            'dt': 'Account',
            'label': 'RGS Omslagcode',
            'fieldname': 'rgs_group_code',
            'fieldtype': 'Data',
            'description': 'RGS omslagcode voor groepering van rekeningen',
            'insert_after': 'rgs_code'
        }).insert()
        logging.info('‚úÖ RGS Omslagcode field added')
    
    # RGS Referentienummer
    if not frappe.db.exists('Custom Field', {'dt': 'Account', 'fieldname': 'rgs_reference_number'}):
        frappe.get_doc({
            'doctype': 'Custom Field',
            'dt': 'Account',
            'label': 'RGS Referentienummer',
            'fieldname': 'rgs_reference_number',
            'fieldtype': 'Data',
            'description': 'RGS referentienummer voor unieke identificatie',
            'insert_after': 'rgs_group_code'
        }).insert()
        logging.info('‚úÖ RGS Referentienummer field added')
    
    # RGS Niveau
    if not frappe.db.exists('Custom Field', {'dt': 'Account', 'fieldname': 'rgs_level'}):
        frappe.get_doc({
            'doctype': 'Custom Field',
            'dt': 'Account',
            'label': 'RGS Niveau',
            'fieldname': 'rgs_level',
            'fieldtype': 'Int',
            'description': 'RGS hi√´rarchie niveau (1=hoofdgroep, 2=groep, etc.)',
            'insert_after': 'rgs_reference_number'
        }).insert()
        logging.info('‚úÖ RGS Niveau field added')

try:
    add_rgs_fields()
    frappe.db.commit()
    print('‚úÖ Dutch RGS 3.7 custom fields installed successfully!')
    print('üìä RGS fields are available for all Account records')
    print('üá≥üá± Ready for ZZP-compliant Dutch bookkeeping')
except Exception as e:
    print(f'‚ùå RGS installation failed: {e}')
    import traceback
    traceback.print_exc()
    exit(1)
finally:
    frappe.destroy()
PYTHON_EOF"
        
        echo "üéØ RGS installation completed!"
    depends_on:
      - create-site
    volumes:
      - sites:/home/frappe/frappe-bench/sites
      - logs:/home/frappe/frappe-bench/logs
    profiles:
      - rgs
